# .github/workflows/sync-upstream.yml
name: Sync Upstream

on:
  schedule:
    - cron: '0 4 * * *'      # daily at 04:00 UTC
  workflow_dispatch:

permissions:
  contents: write           # needed to push commits

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4       # latest stable checkout action
        with:
          fetch-depth: 0
      - name: Ensure "upstream" remote exists
        run: |
          if git remote | grep -q '^upstream$'; then
            echo "‚úÖ upstream already exists, skipping add."
          else
            echo "‚ûï upstream missing, adding now‚Ä¶"
            git remote add upstream https://github.com/danny-avila/LibreChat.git
          fi

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
      - name: gitattributes protections (pre-merge)
        run: |
          gitattributepatterns=(
            "client/src/plugin-runtime/** merge=ours"
            "plugins/** merge=ours"
            "scripts/** merge=ours"
            "codemods/** merge=ours"
            ".bun-version merge=ours"
          )
          for pat in "${gitattributepatterns[@]}"; do
            grep -qxF "$pat" .gitattributes || echo "$pat" >> .gitattributes
          done
          git config merge.ours.driver true
          git add .gitattributes && git commit -m "chore: .gitattributes merge=ours pre-merge" || true
      - name: update upstream remote & merge
        run: |
          git fetch upstream main
          git checkout main
          git pull --ff-only origin main
          git merge upstream/main -m "chore: merge upstream/main into fork"
      - name: Append merge=ours rules (post-merge)
        run: |
          for pat in "${gitattributepatterns[@]}"; do
            grep -qxF "$pat" .gitattributes || echo "$pat" >> .gitattributes
          done
          git config merge.ours.driver true
          git add .gitattributes && git commit -m "chore: .gitattributes merge=ours post-merge" || true
      - name: üîç Cleaning up JS lockfiles‚Ä¶
        run: find . -maxdepth 2 -type f \( -name 'package-lock.json' -o -name 'yarn.lock' -o -name 'pnpm-lock.yaml' -o -name 'bun.lockb' \) -print -exec rm -f {} +
        
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: '.bun-version'
          
      - name: Update package.json dependencies
        run: bun run scripts/update-packagejson.js
        
      - name: Installing dependencies‚Ä¶
        run: bun install

      - name: Apply insert-pluginloader.js codemod
        run: bun run jscodeshift \
          --parser=tsx \
          --extensions=tsx,ts,js,jsx \
          -t codemods/insert-pluginloader.js \
          client/src/main.jsx

      - name: Apply insert-vite-config.js codemod
        run: bun run jscodeshift \
          --parser=tsx \
          --extensions=ts,tsx,js,jsx \
          -t codemods/insert-vite-config.js \
          client/vite.config.ts

      - name: Apply inline-pluginserver-elysia.js codemod
        run: bun run jscodeshift \
          --parser=tsx \
          --extensions=ts,tsx,js,jsx \
          -t codemods/inline-pluginserver-elysia.js\
          api/app/index.js

      - name: Apply inject-otel-bun.js codemod
        run: bun run jscodeshift \
          --parser=tsx \
          --extensions=ts,tsx,js,jsx \
          -t codemods/inject-otel-bun.js \
          api/app/index.js

      - name: Apply replace-fs-with-bun-io.js codemod
        run: bun run jscodeshift \
          --parser=tsx \
          --extensions=ts,tsx,js,jsx \
          -t codemods/replace-fs-with-bun-io.js \
          .

      - name: Apply update-index-html.js codemod
        run: bun run scripts/update-index-html.js

      - name: Clean api/app dependencies
        run: bun install --cwd api/app        # frontend install
      - name: Clean client dependencies
        run: bun install --cwd client        # frontend install
      - name: Commit & push changes
        uses: EndBug/add-and-commit@v9.1.4  # latest stable add-and-commit
        with:
          author_name: "github-actions"
          author_email: "actions@github.com"
          message: "chore: bun+elysia full migration + bun-native I/O + OTEL"
          push: true
